<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product List - Arjanmal Attarchand</title>
    <link rel="stylesheet" href="/styles/admin.css">
    <script>
        // Apply sidebar state immediately to prevent flickering (using sessionStorage)
        (function() {
            try {
                var savedState = sessionStorage.getItem('sidebarMinimized');
                if (savedState === 'true' && document.head) {
                    var style = document.createElement('style');
                    style.id = 'sidebar-preload-state';
                    style.textContent = '#sidebar{width:80px!important}.main-content{margin-left:80px!important;width:calc(100vw - 80px)!important}';
                    document.head.appendChild(style);
                }
            } catch(e) {}
        })();
    </script>
      <link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/favicon.png">

</head>
<body>
    <div class="main-wrapper">
        <div id="dashboardPage" class="dashboard-container" style="display: flex;">
            <!-- Header Placeholder -->
            <div id="header-placeholder"><%- include('partials/header') %></div>

            <!-- Dashboard Body -->
            <div class="dashboard-body">
                <!-- Sidebar Placeholder -->
                <div id="sidebar-placeholder"><%- include('partials/sidebar') %></div>

                <!-- Main Content -->
                <main class="main-content">
                    <div class="content-header">
                        <h1>Product List</h1>
                        <p>Manage your products</p>
                    </div>
                    <div class="content-body">
                        <div class="product-list">
                            <!-- Filter Section -->
                            <div class="form-container" style="margin-bottom: 20px;">
                                <h3 style="margin: 0 0 20px 0; font-size: 18px; color: #FFD700; font-weight: 600;">Filters</h3>
                                <div class="form-row">
                                    <div class="form-group-inline">
                                        <label for="filterName">Product Name</label>
                                        <input type="text" id="filterName" placeholder="Search by name...">
                                    </div>
                                    <div class="form-group-inline">
                                        <label for="filterIndustry">Industry</label>
                                        <select id="filterIndustry">
                                            <option value="">All Industries</option>
                                        </select>
                                    </div>
                                    <div class="form-group-inline">
                                        <label for="filterSize">Size</label>
                                        <select id="filterSize">
                                            <option value="">All Sizes</option>
                                        </select>
                                    </div>
                                    <div class="form-group-inline">
                                        <label for="filterStatus">Status</label>
                                        <select id="filterStatus">
                                            <option value="">All Status</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="featured">Featured</option>
                                            <option value="outofstock">Out of Stock</option>
                                            <option value="signature">Signature</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions" style="margin-top: 20px;">
                                    <button type="button" id="applyFilters" class="btn btn-save">Apply Filters</button>
                                    <button type="button" id="clearFilters" class="btn btn-cancel">Clear Filters</button>
                                </div>
                            </div>
                            
                            <div class="product-list-header">
                                <h2>All Products</h2>
                                <input type="text" class="search-box" placeholder="Search products..." id="searchProducts">
                            </div>
                            <div class="table-wrapper">
                            <table class="product-table">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Name</th>
                                        <th>Industry</th>
                                        <th>Size</th>
                                        <th>Status</th>
                                        <th>Quick Actions</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productTableBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">No products added yet</td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- Footer Placeholder -->
            <div id="footer-placeholder"><%- include('partials/footer') %></div>
        </div>
    </div>
    <script src="/js/partials-loader.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/header-handler.js"></script>
    <script id="products-data" type="application/json">
        <%- JSON.stringify(products || []) %>
    </script>
    <script>
        const PRODUCTS = JSON.parse(document.getElementById('products-data').textContent);
        
        // Get unique values for filter dropdowns
        function getUniqueIndustries() {
            const industries = new Set();
            PRODUCTS.forEach(product => {
                if (product.units && product.units.industryList) {
                    const industryList = Array.isArray(product.units.industryList) 
                        ? product.units.industryList 
                        : [product.units.industryList];
                    industryList.forEach(ind => {
                        if (ind) industries.add(ind);
                    });
                }
            });
            return Array.from(industries).sort();
        }
        
        function getUniqueSizes() {
            const sizes = new Set();
            PRODUCTS.forEach(product => {
                if (product.units && product.units.sizeList) {
                    const sizeList = Array.isArray(product.units.sizeList) 
                        ? product.units.sizeList 
                        : [product.units.sizeList];
                    sizeList.forEach(size => {
                        if (size) sizes.add(size);
                    });
                }
            });
            return Array.from(sizes).sort();
        }
        
        // Populate filter dropdowns
        function populateFilterDropdowns() {
            const industryFilter = document.getElementById('filterIndustry');
            const sizeFilter = document.getElementById('filterSize');
            
            if (industryFilter) {
                const industries = getUniqueIndustries();
                industries.forEach(ind => {
                    const option = document.createElement('option');
                    option.value = ind;
                    option.textContent = ind;
                    industryFilter.appendChild(option);
                });
            }
            
            if (sizeFilter) {
                const sizes = getUniqueSizes();
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = size;
                    sizeFilter.appendChild(option);
                });
            }
        }
        
        // Render Product List
        function renderProductList(searchTerm = '', filters = {}) {
            const productTableBody = document.getElementById('productTableBody');
            if (!productTableBody) return;
            
            let filteredProducts = PRODUCTS.filter(product => {
                // Name filter (from search box or filter section)
                const nameFilter = filters.name || searchTerm;
                if (nameFilter && !product.name.toLowerCase().includes(nameFilter.toLowerCase())) {
                    return false;
                }
                
                // Industry filter
                if (filters.industry) {
                    if (!product.units || !product.units.industryList) {
                        return false;
                    }
                    const industryList = Array.isArray(product.units.industryList) 
                        ? product.units.industryList 
                        : [product.units.industryList];
                    if (!industryList.includes(filters.industry)) {
                        return false;
                    }
                }
                
                // Size filter
                if (filters.size) {
                    if (!product.units || !product.units.sizeList) {
                        return false;
                    }
                    const sizeList = Array.isArray(product.units.sizeList) 
                        ? product.units.sizeList 
                        : [product.units.sizeList];
                    if (!sizeList.includes(filters.size)) {
                        return false;
                    }
                }
                
                // Status filter
                if (filters.status) {
                    switch(filters.status) {
                        case 'active':
                            if (!product.active) return false;
                            break;
                        case 'inactive':
                            if (product.active) return false;
                            break;
                        case 'featured':
                            if (!product.featured) return false;
                            break;
                        case 'outofstock':
                            if (!product.outofstock) return false;
                            break;
                        case 'signature':
                            if (!product.signature) return false;
                            break;
                    }
                }
                
                return true;
            });

            if (filteredProducts.length === 0) {
                productTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #999;">
                            ${searchTerm ? 'No products found' : 'No products added yet'}
                        </td>
                    </tr>
                `;
                return;
            }

            productTableBody.innerHTML = filteredProducts.map(product => {
                let badges = '';
                if (product.active) badges += '<span class="badge badge-active">Active</span>';
                else badges += '<span class="badge badge-inactive" style="background: #f44336 !important; color: #ffffff !important;">Inactive</span>';
                if (product.featured) badges += '<span class="badge badge-featured" style="background: #FFD700 !important; color: #000000 !important;">Featured</span>';
                if (product.topRated) badges += '<span class="badge badge-featured" style="background: #FFD700 !important; color: #000000 !important;">Top Rated</span>';
                if (product.bestSeller) badges += '<span class="badge badge-featured" style="background: #FFD700 !important; color: #000000 !important;">Best Seller</span>';
                if (product.onSale) badges += '<span class="badge badge-featured" style="background: #FFD700 !important; color: #000000 !important;">On Sale</span>';
                if (product.outofstock) badges += '<span class="badge badge-inactive" style="background: #f44336 !important; color: #ffffff !important;">Out of Stock</span>';
                if (product.signature) badges += '<span class="badge badge-featured" style="background: #FFD700; color: #000;">Signature</span>';
                
                const firstImage = (product.images && product.images.length > 0) 
                    ? product.images[0] 
                    : '/uploads/default.png';
                
                // Get industry display
                let industryList = [];
                if (product.units && product.units.industryList) {
                    industryList = Array.isArray(product.units.industryList) 
                        ? product.units.industryList 
                        : [product.units.industryList];
                }
                const industryDisplay = industryList.length > 0 ? industryList.join(', ') : 'N/A';
                
                // Get all sizes display
                let sizeList = [];
                if (product.units && product.units.sizeList) {
                    sizeList = Array.isArray(product.units.sizeList) 
                        ? product.units.sizeList 
                        : [product.units.sizeList];
                }
                const sizeDisplay = sizeList.length > 0 ? sizeList.join(', ') : 'N/A';
                
                return `
                <tr>
                    <td>
                        <img src="${firstImage}" alt="${product.name}" class="product-image-cell" onerror="this.src='/uploads/default.png'">
                    </td>
                    <td>${product.name}</td>
                    <td style="color: #ffffff !important;">${industryDisplay}</td>
                    <td style="color: #ffffff !important;">${sizeDisplay}</td>
                    <td>${badges}</td>
                    <td>
                        <div class="action-buttons" style="display: flex; flex-direction: column; gap: 6px;">
                            <button 
                                class="btn-icon ${product.active ? 'btn-active' : 'btn-inactive'}" 
                                onclick="toggleActive('${product._id}', ${product.active})"
                                style="padding: 6px 12px; font-size: 12px; min-width: 100px;">
                                ${product.active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button 
                                class="btn-icon ${product.outofstock ? 'btn-inactive' : 'btn-active'}" 
                                onclick="toggleStock('${product._id}', ${product.outofstock})"
                                style="padding: 6px 12px; font-size: 12px; min-width: 100px;">
                                ${product.outofstock ? 'Mark In Stock' : 'Mark Out of Stock'}
                            </button>
                            <button 
                                class="btn-icon ${product.signature ? 'btn-active' : 'btn-inactive'}" 
                                onclick="toggleSignature('${product._id}', ${product.signature})"
                                style="padding: 6px 12px; font-size: 12px; min-width: 100px; background: ${product.signature ? '#FFD700' : '#6c757d'}; color: ${product.signature ? '#000' : '#fff'};">
                                ${product.signature ? 'Remove Signature' : 'Add Signature'}
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="window.editProduct('${product._id}')">Edit</button>
                            <button class="btn-icon btn-delete" onclick="window.deleteProduct('${product._id}')">Delete</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // Get current filters
        function getCurrentFilters() {
            return {
                name: document.getElementById('filterName')?.value || '',
                industry: document.getElementById('filterIndustry')?.value || '',
                size: document.getElementById('filterSize')?.value || '',
                status: document.getElementById('filterStatus')?.value || ''
            };
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('filterName').value = '';
            document.getElementById('filterIndustry').value = '';
            document.getElementById('filterSize').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchProducts').value = '';
            // Reset to show all products
            renderProductList('', {});
        }
        
        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchProducts')?.value || '';
            const filters = getCurrentFilters();
            renderProductList(searchTerm, filters);
        }
        
        // Search functionality
        document.addEventListener('DOMContentLoaded', () => {
            populateFilterDropdowns();
            renderProductList();
            
            // Search box - still works in real-time
            const searchProducts = document.getElementById('searchProducts');
            if (searchProducts) {
                searchProducts.addEventListener('input', () => {
                    const searchTerm = searchProducts.value || '';
                    const filters = getCurrentFilters();
                    renderProductList(searchTerm, filters);
                });
            }
            
            // Apply Filters button
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }
            
            // Clear Filters button
            const clearFiltersBtn = document.getElementById('clearFilters');
            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', clearFilters);
            }
            
            // Allow Enter key to apply filters in filter inputs
            const filterInputs = ['filterName', 'filterIndustry', 'filterSize', 'filterStatus'];
            filterInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            applyFilters();
                        }
                    });
                }
            });
        });

        // Product Actions
        window.editProduct = (id) => {
            window.location.href = `/admin/products/edit/${id}`;
        };

        window.deleteProduct = async (id) => {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:white;padding:20px 28px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.2);z-index:9999;text-align:center;';
            messageDiv.innerHTML = `
                <p style="margin-bottom:16px;color:#333;font-size:15px;">Are you sure you want to delete this product?</p>
                <button id="confirmDelete" style="padding:8px 20px;background:#c62828;color:white;border:none;border-radius:4px;margin-right:8px;cursor:pointer;">Delete</button>
                <button id="cancelDelete" style="padding:8px 20px;background:#f0f0f0;color:#666;border:none;border-radius:4px;cursor:pointer;">Cancel</button>
            `;
            document.body.appendChild(messageDiv);
            
            document.getElementById('confirmDelete').onclick = async () => {
                try {
                    const response = await fetch(`/admin/products/delete/${id}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (response.ok && data.success) {
                        // Remove from local array and re-render
                        const index = PRODUCTS.findIndex(p => p._id === id);
                        if (index > -1) {
                            PRODUCTS.splice(index, 1);
                        }
                        const filters = getCurrentFilters();
                        const searchTerm = document.getElementById('searchProducts')?.value || '';
                        renderProductList(searchTerm, filters);
                        messageDiv.remove();
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#d4edda;color:#155724;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;';
                        successMsg.textContent = 'Product deleted successfully';
                        document.body.appendChild(successMsg);
                        setTimeout(() => successMsg.remove(), 2000);
                        // Reload page to refresh data
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        alert(data.message || 'Failed to delete product');
                        messageDiv.remove();
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product');
                    messageDiv.remove();
                }
            };
            
            document.getElementById('cancelDelete').onclick = () => {
                messageDiv.remove();
            };
        };

        // Toggle Active/Inactive
        window.toggleActive = async (id, currentStatus) => {
            try {
                const response = await fetch(`/admin/products/toggle-active/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ active: !currentStatus })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    alert('Error: Invalid response from server');
                    return;
                }
                
                if (response.ok && data.success) {
                    // Update local array
                    const product = PRODUCTS.find(p => p._id === id);
                    if (product) {
                        product.active = !currentStatus;
                    }
                    const filters = getCurrentFilters();
                    const searchTerm = document.getElementById('searchProducts')?.value || '';
                    renderProductList(searchTerm, filters);
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#d4edda;color:#155724;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;';
                    successMsg.textContent = `Product ${!currentStatus ? 'activated' : 'deactivated'} successfully`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 2000);
                } else {
                    alert(data.message || `Failed to update product status. Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error toggling active status:', error);
                alert(`Error updating product status: ${error.message}`);
            }
        };

        // Toggle Signature Status
        window.toggleSignature = async (id, currentStatus) => {
            try {
                // If trying to add signature, check if we already have 3
                if (!currentStatus) {
                    const signatureCount = PRODUCTS.filter(p => p.signature).length;
                    if (signatureCount >= 3) {
                        alert('Maximum 3 signature products allowed. Please remove a signature product first before adding a new one.');
                        return;
                    }
                }
                
                const response = await fetch(`/admin/products/toggle-signature/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ signature: !currentStatus })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    alert('Error: Invalid response from server');
                    return;
                }
                
                if (response.ok && data.success) {
                    // Update local array
                    const product = PRODUCTS.find(p => p._id === id);
                    if (product) {
                        product.signature = !currentStatus;
                    }
                    const filters = getCurrentFilters();
                    const searchTerm = document.getElementById('searchProducts')?.value || '';
                    renderProductList(searchTerm, filters);
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#d4edda;color:#155724;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;';
                    successMsg.textContent = `Product ${!currentStatus ? 'added to' : 'removed from'} signature collection`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 2000);
                } else {
                    alert(data.message || `Failed to update signature status. Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error toggling signature status:', error);
                alert(`Error updating signature status: ${error.message}`);
            }
        };

        // Toggle Stock Status
        window.toggleStock = async (id, currentStatus) => {
            try {
                const response = await fetch(`/admin/products/toggle-stock/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ outofstock: !currentStatus })
                });
                
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    alert('Error: Invalid response from server');
                    return;
                }
                
                if (response.ok && data.success) {
                    // Update local array
                    const product = PRODUCTS.find(p => p._id === id);
                    if (product) {
                        product.outofstock = !currentStatus;
                    }
                    const filters = getCurrentFilters();
                    const searchTerm = document.getElementById('searchProducts')?.value || '';
                    renderProductList(searchTerm, filters);
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#d4edda;color:#155724;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;';
                    successMsg.textContent = `Product marked as ${!currentStatus ? 'out of stock' : 'in stock'}`;
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 2000);
                } else {
                    alert(data.message || `Failed to update stock status. Status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error toggling stock status:', error);
                alert(`Error updating stock status: ${error.message}`);
            }
        };
    </script>
</body>
</html>
